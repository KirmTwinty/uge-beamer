%==============================================================================
%
% Created by Romain NOEL
% MyBeamerExtra 0.1.a
% 2020-12-12
% univ-Eiffel corporate design
% Based on LaTeX UGE Presentation Template
%
%==============================================================================
\ProvidesPackage{beamerthemeMyProgressBar}[2020/12/12]
\makeatletter
	
	\newcommand{\my@bigsize}{7}
	\newcommand{\my@medsize}{6}
	\newcommand{\my@smallsize}{3}
	
	\newlength{\my@tempsize}
	
	\newcounter{my@sectnum}
	
	\newcommand{\my@lastdigit}[1]{%
		\loop\ifnum\value{#1}>9\addtocounter{#1}{-10}\repeat
		\arabic{#1}%
	}
	
	\newcommand\my@fixedbox[2]{%
		\makebox[#1]{\rule[-0ex]{0pt}{0ex}#2}%
	}
	
	\newcommand\my@colorbox[3]{%
		{\setlength{\fboxsep}{0pt}\colorbox{#1}{\my@fixedbox{#2}{#3}}}%
	}
	
	\def\my@temptext{}
	
	\newcommand{\my@navbox}[1][]{%
		\if\relax\detokenize{#1}\relax
		\def\my@tempbox{\my@fixedbox}%
		\else
		\def\my@tempbox{\my@colorbox{#1}}%
		\fi
		\ifx\my@box\my@bigbox
		\def\my@temptext{\my@lastdigit{my@sectnum}}%
		\fi
		\ifx\my@box\my@medbox
		\def\my@temptext{$\diamond$}%
		\fi
		\ifx\my@box\my@smallbox
		\def\my@temptext{$\cdot$}%
		\fi
		\my@tempbox{\my@tempsize}{\my@temptext}%
	}
	
	\newcommand{\my@navboxdone}[1][]{%
		\if\relax\detokenize{#1}\relax
		\def\my@tempbox{\my@fixedbox}%
		\else
		\def\my@tempbox{\my@colorbox{#1}}%
		\fi
		\ifx\my@box\my@bigbox
		\def\my@temptext{\my@lastdigit{my@sectnum}}%
		\else
		\def\my@temptext{x}%
		\fi
		\my@tempbox{\my@tempsize}{\my@temptext}%
	}
	
	\defbeamertemplate{navigation box}{home}{%
		\setlength{\my@tempsize}{\my@box@size pt}%
	%	\my@colorbox{teal!60}{\my@tempsize}{$\equiv$}%
		\my@fixedbox{\my@tempsize}{$\equiv$}
	}
	
	\defbeamertemplate{navigation box}{done}{%
		\setlength{\my@tempsize}{\my@box@size pt}%
		\my@navboxdone%[teal!60]%
	}
	
	\defbeamertemplate{navigation box}{todo}{%
		\setlength{\my@tempsize}{\my@box@size pt}%
		\my@navbox%[blue]
	}
	
	\newcommand{\my@bigbox}{\global\let\my@box@size=\my@bigsize\usebeamertemplate{navigation box}}
	\newcommand{\my@medbox}{\global\let\my@box@size=\my@medsize\usebeamertemplate{navigation box}}
	\newcommand{\my@smallbox}{\global\let\my@box@size=\my@smallsize\usebeamertemplate{navigation box}}
	
	\renewcommand{\sectionentry}[5]{\global\let\my@box=\my@bigbox\setcounter{my@sectnum}{#1}}
	\renewcommand{\beamer@subsectionentry}[5]{\global\let\my@box=\my@medbox}
	
	\renewcommand{\slideentry}[6]{%
		\def\my@temp@i{1/1}%
		\def\my@temp@ii{#4}%
		\ifx\my@temp@i\my@temp@ii % title page
		\setbeamertemplate{navigation box}[home]%
		\else
		\setbeamertemplate{navigation box}[done]%
		\fi
		\ifnum\c@section<#1%
		\setbeamertemplate{navigation box}[todo]%
		\else
		\ifnum\c@section=#1\ifnum\c@subsection<#2%
		\setbeamertemplate{navigation box}[todo]%
		\else
		\ifnum\c@subsection=#2\ifnum\c@subsectionslide<#3%
		\setbeamertemplate{navigation box}[todo]%
		\fi\fi
		\fi\fi
		\fi
		\ifx\my@temp@i\my@temp@ii % title page
		\beamer@link(#4){\my@bigbox}%
		\else
		\beamer@link(#4){\my@box}%
		\fi
		\global\let\my@box=\my@smallbox
	}
	
	\def\basiceval#1{\the\numexpr#1\relax}
	
	
	\setbeamertemplate{progress bar in head/foot}{
	%	\nointerlineskip
		\setlength{\metropolis@progressinheadfoot}{%
			0.9\paperwidth * \ratio{\insertframenumber pt}{\inserttotalframenumber pt}%
		}%
		\begin{beamercolorbox}[wd=\paperwidth,ht=1.0\metropolis@progressinheadfoot@linewidth]{footline}
			\ 
	%		\tikzexternaldisable%
			\begin{tikzpicture}[rounded corners=2pt,very thin]
				\shade[top color=bg!65,bottom color=bg!65,middle color=bg]
				(0pt, 0pt) rectangle ++ (0.9\paperwidth, \metropolis@progressinheadfoot@linewidth);
				
				\shade[draw=fg,top color=fg!70,bottom color=fg!70,middle color=fg] %
				(0pt, 0pt) rectangle ++ (\metropolis@progressinheadfoot, \metropolis@progressinheadfoot@linewidth);
		
				\draw[color=normal text.fg!50]  
				(0pt, 0pt) rectangle (0.9\paperwidth, \metropolis@progressinheadfoot@linewidth) 
				node[pos=0.5] {
					\usebeamercolor[fg]{normal text}\dohead
				};
			\end{tikzpicture}% 
			\hfill
			\raisebox{0.5\metropolis@progressinheadfoot@linewidth-0.5ex}{\basiceval{\insertframenumber*100/\inserttotalframenumber}\,\%}
			\hfill \
		\end{beamercolorbox}
	}

	\setlength{\metropolis@progressinheadfoot@linewidth}{1.0ex}
\makeatother